<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0a6">
  <title>QR 巡邏 / QR Patrol</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body{font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",Arial,sans-serif;margin:0;padding:16px;background:#f9fafb}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{font-size:18px;margin:0 0 8px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    label{display:block;font-size:14px;margin-bottom:6px}
    input,button{font-size:16px;padding:12px;border-radius:10px;border:1px solid #cbd5e1;width:100%;box-sizing:border-box;background:#fff}
    button.primary{background:#0ea5e9;color:#fff;border-color:#0284c7}
    .pill{width:auto;border-radius:999px;padding:8px 12px}
    video{width:100%;background:#000;border-radius:12px}
    .row{display:flex;gap:10px}.row>*{flex:1}
    .small{font-size:12px;color:#64748b}.muted{color:#94a3b8}.ok{color:#059669}.err{color:#b91c1c}
    ul{margin:6px 0 0 18px}
    footer{margin-top:16px;text-align:center;color:#94a3b8;font-size:12px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 18px);padding:10px 14px;border-radius:999px;color:#fff;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,.18);display:none;z-index:9999;letter-spacing:.5px}
    .toast.show{display:inline-block;animation:fade .15s ease-out}
    .toast.info{background:#0284c7}.toast.success{background:#059669}.toast.error{background:#b91c1c}
    @keyframes fade{from{opacity:0;transform:translate(-50%,8px)} to{opacity:1;transform:translate(-50%,0)}}
  </style>
</head>
<body>
  <header>
    <h1 data-i18n="title">QR 巡邏</h1>
    <button id="langToggle" class="pill">EN</button>
  </header>

  <div class="card">
    <label data-i18n="serverLabel">伺服器設定（貼 Apps Script <code>/exec</code>）</label>
    <input id="endpoint" placeholder="例如：https://script.google.com/macros/s/XXXX/exec" data-i18n-ph="endpointPH">
    <div class="row" style="margin-top:10px">
      <button id="save" class="primary" data-i18n="save">儲存</button>
      <button id="ping" data-i18n="test">測試連線</button>
      <button id="flush" data-i18n="uploadOffline">上傳離線</button>
    </div>
    <div id="pingMsg" class="small muted"></div>
  </div>

  <div class="card">
    <label data-i18n="guardLabel">警衛 ID / 姓名</label>
    <input id="guard" placeholder="例如：A001 或 王小明" data-i18n-ph="guardPH">
  </div>

  <div class="card">
    <label data-i18n="scanLabel">掃描 QR Code</label>
    <video id="preview" playsinline></video>
    <div class="row" style="margin-top:10px">
      <button id="start" class="primary" data-i18n="start">開啟相機並開始掃描</button>
      <button id="stop" data-i18n="stop">停止</button>
    </div>
    <div id="status" class="small muted" data-i18n="statusNotStarted">尚未掃描</div>
  </div>

  <div class="card">
    <label data-i18n="manualLabel">沒有相機？手動輸入站點代碼</label>
    <div class="row">
      <input id="manual" placeholder="例如：S-01 或 Lobby-Left" data-i18n-ph="manualPH">
      <button id="sendManual" class="primary" data-i18n="submit">送出</button>
    </div>
  </div>

  <div class="card">
    <label data-i18n="queueLabel">離線佇列</label>
    <ul id="queueList" class="small"></ul>
  </div>

  <footer data-i18n="footer">加入主畫面後可全螢幕使用（PWA）</footer>
  <div id="toast" class="toast"></div>

  <!-- i18n dictionary & toggle -->
  <script>
    const I18N = {
      "zh": {
        title: "QR 巡邏",
        serverLabel: "伺服器設定（貼 Apps Script <code>/exec</code>）",
        endpointPH: "例如：https://script.google.com/macros/s/XXXX/exec",
        save: "儲存",
        test: "測試連線",
        uploadOffline: "上傳離線",
        guardLabel: "警衛 ID / 姓名",
        guardPH: "例如：A001 或 王小明",
        scanLabel: "掃描 QR Code",
        start: "開啟相機並開始掃描",
        stop: "停止",
        statusNotStarted: "尚未掃描",
        manualLabel: "沒有相機？手動輸入站點代碼",
        manualPH: "例如：S-01 或 Lobby-Left",
        submit: "送出",
        queueLabel: "離線佇列",
        footer: "加入主畫面後可全螢幕使用（PWA）",
        t_saved: "設定已儲存",
        t_needExec: "請先貼上 /exec 網址",
        t_ok: "連線正常",
        t_fail: "無法連線",
        t_scanning: "掃描中…（掃到即自動停止）",
        t_camFail: "相機開啟失敗：",
        t_stopped: "已停止",
        t_decodeFail: "讀取失敗",
        t_needConfig: "請先設定 /exec 與 警衛ID",
        t_submitted: "✅ 已送出：「{station}」",
        t_offlineSaved: "連線失敗，已暫存離線",
        t_noPending: "沒有待上傳資料",
        t_allUploaded: "離線資料已全部上傳"
      },
      "en": {
        title: "QR Patrol",
        serverLabel: "Server (Apps Script <code>/exec</code>)",
        endpointPH: "e.g. https://script.google.com/macros/s/XXXX/exec",
        save: "Save",
        test: "Test",
        uploadOffline: "Upload Offline",
        guardLabel: "Guard ID / Name",
        guardPH: "e.g. A001 or John",
        scanLabel: "Scan QR Code",
        start: "Open Camera & Start",
        stop: "Stop",
        statusNotStarted: "Not started",
        manualLabel: "No camera? Enter station manually",
        manualPH: "e.g. S-01 or Lobby-Left",
        submit: "Submit",
        queueLabel: "Offline queue",
        footer: "Install to Home Screen for full-screen PWA",
        t_saved: "Saved",
        t_needExec: "Paste /exec first",
        t_ok: "OK",
        t_fail: "Failed",
        t_scanning: "Scanning… (auto-stop on detection)",
        t_camFail: "Camera failed: ",
        t_stopped: "Stopped",
        t_decodeFail: "Decode failed",
        t_needConfig: "Set /exec & Guard ID first",
        t_submitted: "✅ Submitted: {station}",
        t_offlineSaved: "Network failed, saved offline",
        t_noPending: "No pending items",
        t_allUploaded: "All offline items uploaded"
      }
    };
    const LANG_KEY = "qrpatrol.lang";
    function setLang(lang){
      const dict = I18N[lang] || I18N.zh;
      document.documentElement.lang = (lang === "en" ? "en" : "zh-Hant");
      document.getElementById("langToggle").textContent = (lang === "en" ? "中文" : "EN");
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n");
        const html = dict[k] || "";
        el.innerHTML = html;
      });
      document.querySelectorAll("[data-i18n-ph]").forEach(el=>{
        const k = el.getAttribute("data-i18n-ph"); const text = dict[k] || "";
        el.setAttribute("placeholder", text);
      });
      localStorage.setItem(LANG_KEY, lang);
    }
    function t(key, params={}){
      const lang = localStorage.getItem(LANG_KEY) || "zh";
      const dict = I18N[lang] || I18N.zh;
      let s = dict[key] || key;
      Object.keys(params).forEach(p=>{ s = s.replaceAll(`{${p}}`, params[p]); });
      return s;
    }
    window.addEventListener("DOMContentLoaded", ()=>{
      const init = (localStorage.getItem(LANG_KEY) || ((navigator.language||"").toLowerCase().startsWith("en")? "en":"zh"));
      setLang(init);
      document.getElementById("langToggle").onclick = ()=>{
        const curr = localStorage.getItem(LANG_KEY) || "zh";
        setLang(curr === "zh" ? "en" : "zh");
      };
    });
  </script>

  <!-- load config.json -->
  <script>
  (async () => { 
    try { 
      const res = await fetch('./config.json?v=' + Date.now(), { cache: 'no-store' });
      const cfg = await res.json();
      if (cfg.endpoint) { 
        localStorage.setItem('qrpatrol.endpoint', cfg.endpoint);
        const epInput = document.getElementById('endpoint');
        if (epInput) { epInput.value = cfg.endpoint; epInput.readOnly = true; }
        const saveBtn = document.getElementById('save'); if (saveBtn) saveBtn.style.display = 'none';
        const pingBtn = document.getElementById('ping'); if (pingBtn) pingBtn.click();
      }
      if (cfg.appName && document.title) document.title = cfg.appName;
    } catch(e) { console.warn('讀取 config.json 失敗，改用手動輸入模式', e); }
  })();
  </script>

  <script>
    if ('serviceWorker' in navigator) { 
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js?v=i18n1').catch(e=>console.warn('SW reg fail', e));
      });
    }
  </script>

  <script src="https://unpkg.com/@zxing/library@latest"></script>
  <script>
    const $=id=>document.getElementById(id);
    const LS={ep:"qrpatrol.endpoint",gid:"qrpatrol.guard",q:"qrpatrol.queue"};
    $("endpoint").value=localStorage.getItem(LS.ep)||"";
    $("guard").value=localStorage.getItem(LS.gid)||"";
    renderQueue();

    $("save").onclick=()=>{localStorage.setItem(LS.ep,$("endpoint").value.trim());localStorage.setItem(LS.gid,$("guard").value.trim());toast(t("t_saved"),"success");msg(t("t_saved"),true)};
    $("ping").onclick=async()=>{
      const ep=$("endpoint").value.trim();
      if(!ep){toast(t("t_needExec"),"error");return msg(t("t_needExec"),false)}
      try{const r=await fetch(ep+"?ping=1");$("pingMsg").textContent="Response: "+await r.text();toast(t("t_ok"),"success")}
      catch(e){$("pingMsg").textContent="Failed: "+e.message;toast(t("t_fail"),"error")}
    };
    $("sendManual").onclick=()=>handleScan(($("manual").value||"").trim());

    let stream=null, reader=null, nativeTimer=null;
    let scanningActive=false, isSending=false, lastKey="", lastTime=0, scanLock=false;
    const COOLDOWN_MS=8000;

    $("start").onclick=async()=>{
      try{
        scanningActive=true;
        if('BarcodeDetector'in window){await startNative();}else{await startZXing();}
        toast(t("t_scanning"),"info"); msg(t("t_scanning"),true);
      }catch(e){scanningActive=false;toast(t("t_camFail")+e.message,"error");msg(t("t_camFail")+e.message,false)}
    };
    $("stop").onclick=()=>{scanningActive=false;stopAll();toast(t("t_stopped"),"info")};

    async function startNative(){
      const detector=new BarcodeDetector({formats:["qr_code"]});
      stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      $("preview").srcObject=stream; await $("preview").play();
      nativeTimer=setInterval(async()=>{
        if(!scanningActive) return;
        try{
          const bitmap=await createImageBitmap($("preview"));
          const ds=await detector.detect(bitmap);
          if(!scanningActive) return;
          if(ds && ds.length){
            const text=ds[0].rawValue||"";
            if(text){ if (scanLock) return; scanLock=true; await handleScan(text); }
          }
        }catch(_){}
      },400);
    }
    async function startZXing(){
      reader = new ZXing.BrowserMultiFormatReader();
      let deviceId;
      try { 
        const devs = await ZXing.BrowserCodeReader.listVideoInputDevices();
        deviceId = (devs.find(d => /back|rear/i.test(d.label)) || devs[0] || {}).deviceId;
      } catch(_) { }
      await reader.decodeFromVideoDevice(deviceId || undefined, $("preview"), async (res, err)=>{
        if(!scanningActive) return;
        if(res && res.getText){ if (scanLock) return; scanLock=true; await handleScan(res.getText()); }
      });
      try { await $("preview").play(); } catch(_) { }
    }
    function stopAll(){
      if(nativeTimer){clearInterval(nativeTimer);nativeTimer=null}
      if(reader){try{reader.reset()}catch(_){} try{reader.stopAsyncDecode&&reader.stopAsyncDecode()}catch(_){} reader=null}
      if(stream){try{stream.getTracks().forEach(t=>t.stop())}catch(_){} stream=null}
      try{$("preview").srcObject=null}catch(_){} 
      msg(t("t_stopped"),true);
      scanLock=false;
    }

    async function handleScan(raw){
      if(!scanningActive) return;
      scanningActive=false; // 立刻停
      stopAll();

      if(!raw){toast(t("t_decodeFail"),"error");return msg(t("t_decodeFail"),false)}
      const ep=$("endpoint").value.trim(), gid=$("guard").value.trim();
      if(!ep||!gid){toast(t("t_needConfig"),"error");return msg(t("t_needConfig"),false)}

      let station=raw;
      try{const u=new URL(raw);const s=u.searchParams.get("station")||u.searchParams.get("id");if(s)station=s}catch(_){}
      station=String(station).trim().toUpperCase();

      const key=gid+"|"+station, nowMs=Date.now();
      if(isSending || (key===lastKey && (nowMs-lastTime)<COOLDOWN_MS)){ return; }
      isSending=true; lastKey=key; lastTime=nowMs;

      let loc=null;
      try{await new Promise(res=>{if(!navigator.geolocation)return res();
        navigator.geolocation.getCurrentPosition(p=>{loc={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy};res();}, _=>res(), {enableHighAccuracy:true,timeout:7000,maximumAge:30000});
      })}catch(_){}

      const payload={station,guardId:gid,scannedAtClient:new Date().toISOString(),location:loc,userAgent:navigator.userAgent};

      try{
        await fetch(ep,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});
        toast(t("t_submitted",{station}),"success"); msg(t("t_submitted",{station}),true);
      }catch(e){
        const arr=JSON.parse(localStorage.getItem(LS.q)||"[]");arr.push(payload);
        localStorage.setItem(LS.q, JSON.stringify(arr)); renderQueue();
        toast(t("t_offlineSaved"),"error"); msg(t("t_offlineSaved"),false);
      }finally{ setTimeout(()=>{isSending=false},1200); scanLock=false; }
    }

    $("flush").onclick=async()=>{
      const ep=$("endpoint").value.trim();
      const arr=JSON.parse(localStorage.getItem(LS.q)||"[]");
      if(!ep){toast(t("t_needExec"),"error");return msg(t("t_needExec"),false)}
      if(!arr.length){toast(t("t_noPending"),"info");return msg(t("t_noPending"),true)}
      for(const it of arr){ try{ await fetch(ep,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(it)}); }catch(_){ } }
      localStorage.removeItem(LS.q); renderQueue(); toast(t("t_allUploaded"),"success"); msg(t("t_allUploaded"),true);
    };

    function renderQueue(){const arr=JSON.parse(localStorage.getItem(LS.q)||"[]");$("queueList").innerHTML=arr.length?arr.map((it,i)=>`<li>${i+1}. ${it.station} @ ${it.scannedAtClient}</li>`).join(""):'<li class="muted">（空）(empty)</li>'}
    function msg(t,good){const el=$("status");el.textContent=t;el.className="small "+(good?"ok":"err")}
    function toast(text,type){const el=$("toast");el.textContent=text;el.className="toast show "+(type||"info");setTimeout(()=>{el.classList.remove("show")},1800)}
  </script>
</body>
</html>
