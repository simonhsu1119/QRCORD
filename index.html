
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0a6">
  <title>QR 巡邏（強化定位+時間）</title>
  <style>
    body{font-family:system-ui,-apple-system,"PingFang TC","Noto Sans TC",Arial,sans-serif;margin:0;padding:16px;background:#f9fafb}
    h1{font-size:18px;margin:0 0 8px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;margin:10px 0;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    label{display:block;font-size:14px;margin-bottom:6px}
    input,button{font-size:16px;padding:12px;border-radius:10px;border:1px solid #cbd5e1;width:100%;box-sizing:border-box;background:#fff}
    button.primary{background:#0ea5e9;color:#fff;border-color:#0284c7}
    video{width:100%;background:#000;border-radius:12px}
    .row{display:flex;gap:10px}.row>*{flex:1}
    .small{font-size:12px;color:#64748b}.muted{color:#94a3b8}.ok{color:#059669}.err{color:#b91c1c}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,0) + 18px);padding:10px 14px;border-radius:999px;color:#fff;font-weight:600;box-shadow:0 8px 20px rgba(0,0,0,.18);display:none;z-index:9999;letter-spacing:.5px}
    .toast.show{display:inline-block;animation:fade .15s ease-out}
    .toast.info{background:#0284c7}.toast.success{background:#059669}.toast.error{background:#b91c1c}
    @keyframes fade{from{opacity:0;transform:translate(-50%,8px)} to{opacity:1;transform:translate(-50%,0)}}
  </style>
</head>
<body>
  <h1>QR 巡邏（強化定位+時間）</h1>

  <div class="card">
    <label>伺服器（/exec）</label>
    <input id="endpoint" placeholder="https://script.google.com/macros/s/XXXX/exec">
    <div class="row" style="margin-top:10px">
      <button id="save" class="primary">儲存</button>
      <button id="ping">測試連線</button>
    </div>
    <div id="pingMsg" class="small muted"></div>
  </div>

  <div class="card">
    <label>警衛 ID / 姓名</label>
    <input id="guard" placeholder="例如：A001 或 王小明">
  </div>

  <div class="card">
    <label>掃描 QR Code（示範：按下面按鈕直接送定位測試）</label>
    <div class="row">
      <button id="testSend" class="primary">測試送出（不掃碼）</button>
    </div>
    <div id="status" class="small muted">尚未送出</div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const $=id=>document.getElementById(id);
    const LS={ep:"qrpatrol.endpoint",gid:"qrpatrol.guard"};
    $("endpoint").value=localStorage.getItem(LS.ep)||"";
    $("guard").value=localStorage.getItem(LS.gid)||"";
    $("save").onclick=()=>{localStorage.setItem(LS.ep,$("endpoint").value.trim());localStorage.setItem(LS.gid,$("guard").value.trim());toast("設定已儲存","success")};
    $("ping").onclick=async()=>{const ep=$("endpoint").value.trim();if(!ep){toast("請先貼上 /exec","error");return}try{const r=await fetch(ep+"?ping=1",{cache:"no-store"});$("pingMsg").textContent="回應："+await r.text();toast("連線正常","success")}catch(e){$("pingMsg").textContent="無法連線："+e.message;toast("無法連線","error")}};

    $("testSend").onclick=async()=>{
      const ep=$("endpoint").value.trim(), gid=$("guard").value.trim();
      if(!ep||!gid){toast("請先設定 /exec 與 警衛ID","error");return}
      const loc=await getBestLocation();
      if(loc){toast(`定位：±${Math.round(loc.acc)}m`, "info")}
      const payload={station:"TEST",guardId:gid,scannedAtClient:new Date().toISOString(),clientTaipei:new Date().toLocaleString("zh-TW",{timeZone:"Asia/Taipei"}),location:loc,userAgent:navigator.userAgent};
      try{await fetch(ep,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(payload)});$("status").textContent="已送出；定位 ±"+(loc?Math.round(loc.acc):"?")+"m"}catch(_){$("status").textContent="送出失敗（可稍後再試）";toast("送出失敗","error")}
    };

    async function getBestLocation(){
      if(!("geolocation" in navigator)) return null;
      const opts={enableHighAccuracy:true,timeout:15000,maximumAge:0};
      const once=()=>new Promise(res=>navigator.geolocation.getCurrentPosition(p=>res(p),_=>res(null),opts));
      let p=await once();
      if(!p) return null;
      let best={lat:p.coords.latitude,lng:p.coords.longitude,acc:p.coords.accuracy};
      if(best.acc>50){
        let watchId=null;
        const improved=new Promise(resolve=>{
          watchId=navigator.geolocation.watchPosition(pp=>{
            if(pp.coords.accuracy<best.acc){best={lat:pp.coords.latitude,lng:pp.coords.longitude,acc:pp.coords.accuracy}}
          },_=>{},opts);
          setTimeout(()=>{navigator.geolocation.clearWatch(watchId);resolve()},8000);
        });
        await improved;
      }
      return best;
    }

    function toast(text,type){const el=$("toast");el.textContent=text;el.className="toast show "+(type||"info");setTimeout(()=>el.classList.remove("show"),1800)}
  </script>
</body>
</html>
